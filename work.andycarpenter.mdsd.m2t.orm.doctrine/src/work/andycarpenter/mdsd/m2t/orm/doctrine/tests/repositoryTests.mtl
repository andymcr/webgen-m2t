[comment encoding = UTF-8 /]
[module repositoryTests(
	'http://andycarpenter.work/metamodel/ObjectRelationalMapping')]
[import work::andycarpenter::mdsd::m2t::orm::doctrine::names/]
[import work::andycarpenter::mdsd::m2t::orm::doctrine::files/]
[import work::andycarpenter::mdsd::m2t::orm::doctrine::uriRoutes/]
[import work::andycarpenter::mdsd::m2t::orm::doctrine::tests::files/]
[import work::andycarpenter::mdsd::m2t::orm::doctrine::tests::names/]
[import work::andycarpenter::mdsd::m2t::orm::doctrine::tests::randomValues/]


[template public repositoryTests(repository : Repository)]
[file(repository.testRepositoryFilename(), false)]
<?php
namespace [repository.testRepositoriesNamespace()/];

use [repository.modelsNamespace()/]\[repository.serves.modelClassName()/];
use [repository.repositoriesNamespace()/]\[repository.repositoryClassName()/];
use [repository.serves.factoriesNamespace()/]\[repository.serves.factoryClassName()/];
use Symfony\Bundle\FrameworkBundle\Test\KernelTestCase;
use Zenstruck\Foundry\Test\ResetDatabase;


class [repository.testRepositoryClassName()/] extends KernelTestCase
{
    use ResetDatabase;

    /**
     * @var [repository.repositoryClassName()/] $repository
     */
    private [repository.repositoryClassName()/] $repository;

    [repository.setUpMethod()/]

    [repository.tearDownMethod()/]

    [repository.testInsertOneMethod()/]

    [repository.testInsertManyMethod()/]

[if (repository.findOne.oclIsUndefined() and repository.serves.hasRouteParameters())]
    [repository.testFindOneMethod()/]

[/if]
[if (not repository.findAll.oclIsUndefined())]
    [repository.findAll.testMethod()/]

[elseif (repository.selections->select(s | s.name.equalsIgnoreCase('all'))->notEmpty())]
    [repository.selections->any(s | s.name.equalsIgnoreCase('all')).testMethod()/]

[/if]
}
[/file]
[/template]

[template private setUpMethod(repository : Repository) post(trim())]
protected function setUp(): void
{
    $kernel = self::bootKernel();

	$this->repository = self::getContainer()->get([repository.repositoryClassName()/]::class);
}
[/template]

[template private tearDownMethod(repository : Repository) post(trim())]
protected function tearDown(): void
{
    parent::tearDown();

    // doing this is recommended to avoid memory leaks
//        $this->entityManager->close();
//        $this->entityManager = null;
}
[/template]

[template private testInsertOneMethod(repository : Repository) post(trim())]
public function testInsertOne(): void
{
	$[repository.serves.instanceName()/] = [repository.serves.factoryClassName()/]::new()->withoutPersisting()->create();
    $count = [repository.serves.factoryClassName()/]::count();
    $this->repository->save($[repository.serves.instanceName()/], true);
    [repository.serves.factoryClassName()/]::assert()->Count($count + 1);
}
[/template]

[template private testInsertManyMethod(repository : Repository) post(trim())]
public function testInsertMany(): void
{
    $addCount = 5;
    $count = [repository.serves.factoryClassName()/]::count();
    foreach ([repository.serves.factoryClassName()/]::new()
            ->withoutPersisting()
            ->many($addCount)
            ->create() as $[repository.serves.instanceName()/]) {
        $this->repository->save($[repository.serves.instanceName()/], true);
    }
    [repository.serves.factoryClassName()/]::assert()->Count($count + $addCount);
}
[/template]

[template private testFindOneMethod(repository : Repository) post(trim())]
public function testFindOne(): void
{
    [repository.serves.factoryClassName()/]::createMany([if (repository.serves.attributeKeys->isEmpty())]5[else]

        5,
        static function(int $i) {
            return [if (repository.serves.attributeKeys->size() = 1)]['['/][for (key : Attribute | repository.serves.attributeKeys)]
'[key.modelPropertyName()/]' => "[key.displayLabel/] $i"[/for][']'/];
[else]['['/]
[for (key : Attribute | repository.serves.attributeKeys)]
                '[key.modelPropertyName()/]' => "[key.displayLabel/] $i",
[/for]
            ['['/]
[/if]
        }
    [/if]);
    $[repository.serves.instanceName()/] = $this->repository->findOne([for (key : Attribute | repository.serves.uriPathKeys()) separator(', ')]
"[key.displayLabel/] 1"[/for]);
    $this->assertNotNull($[repository.serves.instanceName()/]);
}
[/template]


[template private keyValue(key : Attribute) post(trim())]
[if (key.isIntegerFeature)]
0
[elseif (key.isStringFeature)]
''
[/if]
[/template]


[template private testMethod(selection : Selection) post(trim())]
public function est[selection.methodName.toUpperFirst()/](): void
{
    $[selection.definedBy.repositoryInstanceName()/] = static::getContainer()
        ->get([selection.definedBy.repositoryClassName()/]::class);

    [selection.testMethodTests()/]
}
[/template]

[template private testMethodTests(selection : Selection) post(trim())]
$result = $[selection.definedBy.repositoryInstanceName()/]->[selection.methodName/]();
$this->assertCount(0, $result);
[/template]

[template private randomSingletonValue(feature : Feature) post(trim())]
[feature.randomSingletonValue('self::faker()')/]
[/template]