[comment encoding = UTF-8 /]
[module entityTests(
	'http://andycarpenter.work/metamodel/base',
	'http://andycarpenter.work/metamodel/ObjectRelationalMapping',
	'http://andycarpenter.work/metamodel/security')]
[import work::andycarpenter::mdsd::m2t::orm::doctrine::expression/]
[import work::andycarpenter::mdsd::m2t::orm::doctrine::files/]
[import work::andycarpenter::mdsd::m2t::orm::doctrine::names/]
[import work::andycarpenter::mdsd::m2t::orm::doctrine::tests::files/]
[import work::andycarpenter::mdsd::m2t::orm::doctrine::tests::names/]
[import work::andycarpenter::mdsd::m2t::orm::doctrine::tests::randomValues/]


[template public modelTests(entity : Entity)]
[file(entity.testModelFilename(), false)]
<?php
namespace [entity.testModelsNamespace()/];

[for (type : Entity | entity.modelsUsed())]
use [type.modelsNamespace()/]\[type.modelClassName()/];
[/for]
use PHPUnit\Framework\TestCase;


class [entity.testModelClassName()/] extends TestCase
{
    private $faker;

    protected function setUp(): void
    {
        $this->faker = \Faker\Factory::create();
    }

[for (feature : Feature | entity.features
		->select(f | not f.isLocationFeature and not f.isResourceFeature))]
[let getValue : String
	= '$'.concat(feature.partOf.instanceName())
		.concat('->').concat(feature.getMethodName()).concat('()')]
	[if (feature.isSingleton)]
    [feature.testMethodSingletonDefault(getValue)/]

    [feature.testMethodSetValue(getValue)/]

    [feature.testMethodChangeValue(getValue)/]
	[else]
    [feature.testMethodCollectionDefault(getValue)/]

    [feature.testMethodCollectionAdd(getValue)/]

    [feature.testMethodCollectionRemove(getValue)/]
	[/if]

[/let]
[/for]
}
[/file]
[/template]


[query private modelsUsed(entity : Entity) : OrderedSet(Entity)
	= Set{entity}
		->union(entity.associations
			->collect(a | a.opposite.partOf)
			->asSet())
		->sortedBy(modelClassName())
/]

[template private testMethodSingletonDefault(feature : Feature, getValue : String) post(trim())]
public function test[feature.modelPropertyName().toUpperFirst()/]Default(): void
{
	$[feature.partOf.instanceName()/] = new [feature.partOf.modelClassName()/]();
[if (feature.defaultSingletonValue() = 'true')]
    $this->assertTrue([getValue/]);
[elseif (feature.defaultSingletonValue() = 'false')]
    $this->assertFalse([getValue/]);
[elseif (feature.isDateFeature)]
	[if (feature.hasDefaultValue)]
		[if (feature.defaultValue.oclIsTypeOf(CurrentTime))]
    $this->assertEqualsWithDelta([feature.defaultSingletonValue()/], [getValue/], 5);
		[else]
    $this->assertEquals([feature.defaultSingletonValue()/], [getValue/]);
		[/if]
	[elseif (feature.isRequired)]
    $this->assertEqualsWithDelta([feature.defaultSingletonValue()/], [getValue/], 5);
	[else]
    $this->assertNull([getValue/]);
	[/if]
[elseif (feature.isAssociationFeature)]
	[if (feature.isRequired)]
    $this->expectException(\Error::class);
	[/if]
    $this->assertNull([getValue/]);
[else]
    $this->assertEquals([feature.defaultSingletonValue()/], [getValue/]);
[/if]
}
[/template]

[template private testMethodSetValue(feature : Feature, getValue : String) post(trim())]
public function test[feature.modelPropertyName().toUpperFirst()/]SetValue(): void
{
	$[feature.partOf.instanceName()/] = new [feature.partOf.modelClassName()/]();
    $value = [feature.randomSingletonValue()/];
    $[feature.partOf.instanceName()/]->[feature.setMethodName()/]($value);
    $this->assertEquals([if (feature.isCaseInsensitive)]
strtolower($value)[else]$value[/if], [getValue/]);
}
[/template]

[template private testMethodChangeValue(feature : Feature, getValue : String) post(trim())]
public function test[feature.modelPropertyName().toUpperFirst()/]ChangeValue(): void
{
	$[feature.partOf.instanceName()/] = new [feature.partOf.modelClassName()/]();
    $value1 = [feature.randomSingletonValue()/];
    $[feature.partOf.instanceName()/]->[feature.setMethodName()/]($value1);
    $value2 = [feature.randomSingletonValue()/];
    $[feature.partOf.instanceName()/]->[feature.setMethodName()/]($value2);
    $this->assertEquals($value2, [getValue/]);
}
[/template]

[template private testMethodCollectionDefault(feature : Feature, getValue : String) post(trim())]
public function test[feature.modelPropertyName().toUpperFirst()/]Default(): void
{
	$[feature.partOf.instanceName()/] = new [feature.partOf.modelClassName()/]();
[if (feature.partOf.implementsUserInterface and feature.name = 'roles')]
    $this->assertCount(1, [getValue/]);
[else]
    $this->assertCount(0, [getValue/]);
[/if]
}
[/template]

[template private testMethodCollectionAdd(feature : Feature, getValue : String) post(trim())]
public function test[feature.modelPropertyName().toUpperFirst()/]CollectionAdd(): void
{
	$[feature.partOf.instanceName()/] = new [feature.partOf.modelClassName()/]();
    $value1 = [feature.randomSingletonValue()/];
[if (feature.collectionOrmAllowAdd)]
    $[feature.partOf.instanceName()/]->[feature.addMethodName()/]($value1);
[else]
    $[feature.partOf.instanceName()/]->[feature.getMethodName()/]()->add($value1);
[/if]
[if (feature.partOf.implementsUserInterface and feature.name = 'roles')]
    $this->assertCount(2, [getValue/]);
[else]
    $this->assertCount(1, [getValue/]);
[/if]
    $value2 = [feature.randomSingletonValue()/];
[if (feature.collectionOrmAllowAdd)]
    $[feature.partOf.instanceName()/]->[feature.addMethodName()/]($value2);
[else]
    $[feature.partOf.instanceName()/]->[feature.getMethodName()/]()->add($value2);
[/if]
[if (feature.partOf.implementsUserInterface and feature.name = 'roles')]
    $this->assertCount(3, [getValue/]);
[else]
    $this->assertCount(2, [getValue/]);
[/if]
    $value3 = [feature.randomSingletonValue()/];
[if (feature.collectionOrmAllowAdd)]
    $[feature.partOf.instanceName()/]->[feature.addMethodName()/]($value3);
[else]
    $[feature.partOf.instanceName()/]->[feature.getMethodName()/]()->add($value3);
[/if]
[if (feature.partOf.implementsUserInterface and feature.name = 'roles')]
    $this->assertCount(4, [getValue/]);
[else]
    $this->assertCount(3, [getValue/]);
[/if]
[if (feature.isAttributeFeature)]
    $this->assertTrue(in_array($value1, $[feature.partOf.instanceName()/]->[feature.getMethodName()/]()));
    $this->assertTrue(in_array($value2, $[feature.partOf.instanceName()/]->[feature.getMethodName()/]()));
    $this->assertTrue(in_array($value3, $[feature.partOf.instanceName()/]->[feature.getMethodName()/]()));
[else]
    $this->assertTrue($[feature.partOf.instanceName()/]->[feature.getMethodName()/]()->contains($value1));
    $this->assertTrue($[feature.partOf.instanceName()/]->[feature.getMethodName()/]()->contains($value2));
    $this->assertTrue($[feature.partOf.instanceName()/]->[feature.getMethodName()/]()->contains($value3));
[/if]
}
[/template]

[template private testMethodCollectionRemove(feature : Feature, getValue : String) post(trim())]
public function test[feature.modelPropertyName().toUpperFirst()/]CollectionRemove(): void
{
	$[feature.partOf.instanceName()/] = new [feature.partOf.modelClassName()/]();
    $value1 = [feature.randomSingletonValue()/];
    $value2 = [feature.randomSingletonValue()/];
    $value3 = [feature.randomSingletonValue()/];
[if (feature.collectionOrmAllowAdd)]
    $[feature.partOf.instanceName()/]->[feature.addMethodName()/]($value1);
    $[feature.partOf.instanceName()/]->[feature.addMethodName()/]($value2);
    $[feature.partOf.instanceName()/]->[feature.addMethodName()/]($value3);
[else]
    $[feature.partOf.instanceName()/]->[feature.getMethodName()/]()->add($value1);
    $[feature.partOf.instanceName()/]->[feature.getMethodName()/]()->add($value2);
    $[feature.partOf.instanceName()/]->[feature.getMethodName()/]()->add($value3);
[/if]
[if (feature.collectionOrmAllowRemove)]
    $[feature.partOf.instanceName()/]->[feature.removeMethodName()/]($value1);
[else]
    $[feature.partOf.instanceName()/]->[feature.getMethodName()/]()->remove($[feature.partOf.instanceName()/]->[feature.getMethodName()/]()->indexOf($value1));
[/if]
[if (feature.partOf.implementsUserInterface and feature.name = 'roles')]
    $this->assertCount(3, $[feature.partOf.instanceName()/]->[feature.getMethodName()/]());
[else]
    $this->assertCount(2, $[feature.partOf.instanceName()/]->[feature.getMethodName()/]());
[/if]
[if (feature.collectionOrmAllowRemove)]
    $[feature.partOf.instanceName()/]->[feature.removeMethodName()/]($value2);
[else]
    $[feature.partOf.instanceName()/]->[feature.getMethodName()/]()->remove($[feature.partOf.instanceName()/]->[feature.getMethodName()/]()->indexOf($value2));
[/if]
[if (feature.partOf.implementsUserInterface and feature.name = 'roles')]
    $this->assertCount(2, $[feature.partOf.instanceName()/]->[feature.getMethodName()/]());
[else]
    $this->assertCount(1, $[feature.partOf.instanceName()/]->[feature.getMethodName()/]());
[/if]
[if (feature.collectionOrmAllowRemove)]
    $[feature.partOf.instanceName()/]->[feature.removeMethodName()/]($value3);
[else]
    $[feature.partOf.instanceName()/]->[feature.getMethodName()/]()->remove($[feature.partOf.instanceName()/]->[feature.getMethodName()/]()->indexOf($value3));
[/if]
[if (feature.partOf.implementsUserInterface and feature.name = 'roles')]
    $this->assertCount(1, $[feature.partOf.instanceName()/]->[feature.getMethodName()/]());
[else]
    $this->assertCount(0, $[feature.partOf.instanceName()/]->[feature.getMethodName()/]());
[/if]
}
[/template]

[template private defaultSingletonValue(feature : Feature) post(trim())]
[if (feature.hasDefaultValue)]
[feature.defaultValue.defaultExpression()/]
[elseif (feature.isAssociationFeature)]
null
[elseif (feature.isBooleanFeature)]
false
[elseif (feature.isDateFeature)]
new \DateTimeImmutable()
[elseif (feature.isEmailFeature)]
'a@b.c'
[elseif (feature.isEnumerationFeature)]
0
[elseif (feature.isFloatFeature)]
0.0
[elseif (feature.isIntegerFeature)]
0
[elseif (feature.isLocationFeature)]
[elseif (feature.isResourceFeature)]
[elseif (feature.isStringFeature)]
''
[elseif (feature.isTextareaFeature)]
''
[elseif (feature.isUrlFeature)]
''
[else]
''
[/if]
[/template]