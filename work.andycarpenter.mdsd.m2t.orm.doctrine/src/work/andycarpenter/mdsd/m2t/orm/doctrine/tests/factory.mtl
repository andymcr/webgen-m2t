[comment encoding = UTF-8 /]
[module factory(
	'http://andycarpenter.work/metamodel/ObjectRelationalMapping')]
[import work::andycarpenter::mdsd::m2t::orm::doctrine::files/]
[import work::andycarpenter::mdsd::m2t::orm::doctrine::names/]
[import work::andycarpenter::mdsd::m2t::orm::doctrine::tests::files/]
[import work::andycarpenter::mdsd::m2t::orm::doctrine::tests::names/]
[import work::andycarpenter::mdsd::m2t::orm::doctrine::tests::randomValues/]


[template public factory(entity : Entity)]
[file(entity.factoryClassFilename(), false)]
<?php
namespace [entity.factoriesNamespace()/];

use [entity.modelsNamespace()/]\[entity.modelClassName()/];
use [entity.repositoriesNamespace()/]\[entity.repository.repositoryClassName()/];
[for (type : Entity | entity.associations
			->select(f | f.isRequired)
			->collect(a | a.opposite.partOf)
			->asSet()
			->sortedBy(e | e.factoryClassName()))]
use [type.factoriesNamespace()/]\[type.factoryClassName()/];
[/for]
use Zenstruck\Foundry\Persistence\PersistentObjectFactory;
use Zenstruck\Foundry\Persistence\ProxyRepositoryDecorator;


/**
 * @extends PersistentObjectFactory<[entity.modelClassName()/]>
 */
class [entity.factoryClassName()/] extends PersistentObjectFactory
{
    [entity.constructorMethod()/]

    [entity.classMethod()/]

    [entity.defaultsMethod()/]

    [entity.initializeMethod()/]
}
[/file]
[/template]

[template private constructorMethod(entity : Entity) post(trim())]
/**
 * @see https://symfony.com/bundles/ZenstruckFoundryBundle/current/index.html#factories-as-services
 */
public function __construct()
{
}
[/template]

[template private classMethod(entity : Entity) post(trim())]
public static function class(): string
{
    return [entity.modelClassName()/]::class;
}
[/template]

[template private defaultsMethod(entity : Entity) post(trim())]
/**
 * @see https://symfony.com/bundles/ZenstruckFoundryBundle/current/index.html#factories
 */
protected function defaults(): array|callable
{
    return ['['/]
[for (attribute : Attribute | entity.attributes
			->select(f | not f.isLocationFeature and not f.isResourceFeature)
			->select(f | f.isRequired))]
        '[attribute.modelPropertyName()/]' => [attribute.randomSingletonValue('self::faker()')/],
[/for]
[for (association : Association | entity.associations
			->select(f | f.isRequired))]
        '[association.modelPropertyName()/]' => [association.opposite.partOf.factoryClassName()/]::createOne(),
[/for]
    [']'/];
}
[/template]

[template private initializeMethod(entity : Entity) post(trim())]
/**
 * @see https://symfony.com/bundles/ZenstruckFoundryBundle/current/index.html#initialization
 */
protected function initialize(): static
{
    return $this
        // ->afterInstantiate(function(Post $post): void {})
    ;
}
[/template]